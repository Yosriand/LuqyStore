<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Luqqy Store</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-pink-50 min-h-screen">

<header class="bg-gradient-to-r from-pink-400 to-rose-500 text-white p-6 text-center shadow">
  <h1 class="text-3xl font-extrabold">Admin Luqqy Store</h1>
</header>

<div class="max-w-4xl mx-auto p-6">

  <!-- LOGIN -->
  <div id="loginBox" class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-bold mb-4 text-pink-600">Login Admin</h2>

    <input id="email" type="email" placeholder="Email" class="w-full border p-2 rounded mb-2"/>
    <input id="password" type="password" placeholder="Password" class="w-full border p-2 rounded mb-4"/>

    <button id="loginBtn" class="w-full bg-pink-500 text-white p-2 rounded-full mb-2">Login</button>
    <button id="resetBtn" class="text-sm text-pink-500 underline w-full mb-2">Lupa password?</button>
    <button id="backToVisitor" class="w-full border border-pink-400 text-pink-500 p-2 rounded-full hover:bg-pink-50">
      ‚Üê Kembali ke Luqqy Store
    </button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">

    <button id="logoutBtn" class="mb-4 bg-rose-500 text-white px-4 py-2 rounded-full">Logout</button>

    <!-- TAMBAH PRODUK -->
    <div class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-bold mb-4">Tambah Produk</h2>

      <input id="nama" placeholder="Nama Produk *" class="w-full border p-2 rounded mb-2"/>
      <textarea id="deskripsi" placeholder="Deskripsi" class="w-full border p-2 rounded mb-2"></textarea>
      <input id="link" placeholder="Link Affiliate *" class="w-full border p-2 rounded mb-2"/>
      <select id="kategori" class="w-full border p-2 rounded mb-4">
        <option value="">Pilih Kategori *</option>
        <option value="skincare">üíÑ Skincare</option>
        <option value="fashion">üëú Fashion</option>
        <option value="home">üè† Home & Living</option>
      </select>

      <input id="gambar" placeholder="URL Gambar (opsional)" class="w-full border p-2 rounded mb-4"/>

      <button id="simpanBtn" class="w-full bg-pink-500 text-white p-2 rounded-full">Simpan Produk</button>
    </div>

    <!-- PREVIEW PRODUK PER KATEGORI -->
    <div id="produkList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAgvqSOqTr5zeGFArOWYSaUExCAlwEw2gE",
  authDomain: "luqqy-store.firebaseapp.com",
  projectId: "luqqy-store",
  storageBucket: "luqqy-store.firebasestorage.app",
  messagingSenderId: "157194853674",
  appId: "1:157194853674:web:936fac43307d852fedd253"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ELEMENT */
const loginBox = document.getElementById("loginBox");
const dashboard = document.getElementById("dashboard");
const produkList = document.getElementById("produkList");

const email = document.getElementById("email");
const password = document.getElementById("password");
const nama = document.getElementById("nama");
const deskripsi = document.getElementById("deskripsi");
const link = document.getElementById("link");
const kategori = document.getElementById("kategori");
const gambar = document.getElementById("gambar");

/* LOGIN */
loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(err=>alert("Login gagal: "+err.message));
};

/* RESET PASSWORD */
resetBtn.onclick = () => {
  if(!email.value) return alert("Masukkan email");
  sendPasswordResetEmail(auth,email.value).then(()=>alert("üìß Email reset terkirim"));
};

/* BACK TO VISITOR */
backToVisitor.onclick = () => location.href="index.html";

/* LOGOUT */
logoutBtn.onclick = async () => { await signOut(auth); location.href="index.html"; };

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(user){
    loginBox.classList.add("hidden");
    dashboard.classList.remove("hidden");
    loadProdukPreview();
  }else{
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
  }
});

/* SIMPAN PRODUK */
simpanBtn.onclick = async ()=>{
  if(!nama.value || !link.value || !kategori.value){
    alert("‚ùå Nama, Link & Kategori wajib diisi");
    return;
  }
  await addDoc(collection(db,"produk"),{
    nama:nama.value,
    deskripsi:deskripsi.value,
    link:link.value,
    kategori:kategori.value,
    gambar:gambar.value || "", // opsional
    klik:0,
    createdAt:serverTimestamp()
  });
  nama.value=deskripsi.value=link.value=kategori.value=gambar.value="";
  loadProdukPreview();
};

/* LOAD PRODUK PER KATEGORI (LAZY LOAD) */
async function loadProdukPreview(){
  const snap = await getDocs(collection(db,"produk"));
  const allProduk = snap.docs.map(d=>({id:d.id,...d.data()}));

  const kategoriMap = {skincare:[],fashion:[],home:[]};
  allProduk.forEach(p=>{ if(kategoriMap[p.kategori]) kategoriMap[p.kategori].push(p); });

  produkList.innerHTML="";
  Object.entries(kategoriMap).forEach(([key,items])=>{
    if(items.length===0) return;

    const details = document.createElement("details");
    details.className="mb-4 border border-pink-200 rounded-xl bg-white shadow";
    details.innerHTML=`<summary class="cursor-pointer font-bold text-pink-600 p-3">${key.toUpperCase()} (${items.length})</summary>
      <div class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>`;
    const grid = details.querySelector("div");

    // lazy load saat expand
    details.addEventListener("toggle",()=>{
      if(details.open && grid.children.length===0){
        items.forEach(p=>{
          const card = document.createElement("div");
          card.className="bg-white p-3 rounded-xl shadow";
          const imgSrc = p.gambar || "https://via.placeholder.com/400x400/ffe4e6/ec4899?text=Luqqy+Store";
          card.innerHTML=`<div class="mb-2 rounded-xl overflow-hidden"><img src="${imgSrc}" class="w-full h-36 object-cover"/></div>
            <h3 class="font-bold text-pink-700">${p.nama}</h3>
            <p class="text-sm text-gray-500 mb-2">${p.deskripsi||""}</p>
            <a href="${p.link}" target="_blank" class="block bg-pink-400 hover:bg-pink-500 text-white py-2 rounded-full text-center font-semibold">Lihat Produk</a>
            <button class="mt-1 bg-red-100 text-red-500 px-2 py-1 rounded" onclick="hapusProduk('${p.id}')">Hapus</button>`;
          grid.appendChild(card);
        });
      }
    });

    produkList.appendChild(details);
  });
}

/* HAPUS PRODUK */
window.hapusProduk = async id=>{
  if(confirm("Hapus produk ini?")){
    await deleteDoc(doc(db,"produk",id));
    loadProdukPreview();
  }
};
</script>
</body>
</html>
